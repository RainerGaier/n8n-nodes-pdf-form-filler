# Phase 7 — Integration Tests

**Completed:** 2026-02-14

## Summary

Created comprehensive integration tests that verify the full engine+adapter stack end-to-end with real PDF fixtures. Tests use programmatic PDFs generated by pdf-lib, fill them via `PdfFormFillerEngine` + `PdfLibAdapter`, then reload the saved bytes and verify all values persisted correctly. Two new fixture generators were added for the comprehensive form (21 fields) and pre-filled form scenarios.

## Deliverables

### Integration Test File (`test/integration/fillForm.integration.test.ts`)

28 tests organised into 7 describe blocks:

| Group | Tests | Coverage |
|---|---|---|
| text-only form | 2 | Text fields, numeric value coercion |
| mixed-fields form | 5 | All field types, case-insensitive matching, checkbox true/false/"yes" |
| date formatting | 4 | DD/MM/YYYY, MM/DD/YYYY, YYYY-MM-DD, D/M/YY |
| dot-notation data resolution | 2 | Nested objects, array indices |
| partial data and missing values | 5 | Missing keys, suppressed warnings, non-existent PDF field, invalid option, empty mapping |
| edge cases | 4 | Empty form, formless PDF, pre-filled overwrite, read-only field |
| comprehensive form (multi-field) | 4 | 21-field fill+verify, partial fill, field discovery, field type counts |
| discover fields | 2 | Read-only reporting, pre-filled value reporting |

### New Fixtures (`test/fixtures/createTestPdf.ts`)

- **`createComprehensiveForm()`**: 21 fields across 2 pages — 12 text, 4 checkbox, 2 radio, 3 dropdown. Simulates a real-world application form with personal info, addresses, preferences, and agreements.
- **`createPreFilledForm()`**: 4 fields with existing values (text, checkbox, dropdown) for testing overwrite behaviour.

### Key Findings During Testing

1. **pdf-lib lazily creates empty forms**: `PDFDocument.create()` + `addPage()` does not produce a truly "formless" PDF. Calling `getForm()` creates an empty form object. `NoFormError` is only thrown for malformed/missing AcroForm entries in real PDFs, not for programmatic ones.

2. **pdf-lib allows writing to read-only fields**: Read-only is a viewer-level enforcement, not an API-level restriction. The engine successfully writes values to read-only fields — the PDF viewer decides whether to honour the read-only flag.

3. **Round-trip integrity**: All field types survive the fill → save → reload cycle with values intact. Case-insensitive matching correctly returns original PDF case.

## Test Results

- **156 total tests** (26 MappingResolver + 51 ValueCoercer + 4 FieldTypeDetector + 27 PdfLibAdapter + 20 PdfFormFillerEngine + 28 Integration)
- All passing

## Coverage

| Metric | Value |
|---|---|
| Statements | 90.94% |
| Branches | 84.11% |
| Functions | 94.73% |
| Lines | 93.16% |

All metrics above the 80% threshold. Coverage is unchanged from Phase 4 because the integration tests exercise the same `src/` code paths already covered by unit tests — but they validate correctness at the system level.

## Checklist

- [x] `test/integration/fillForm.integration.test.ts` — 28 integration tests
- [x] Comprehensive form test: 21 fields across all types
- [x] Round-trip verification: fill → save → reload → verify
- [x] Edge cases: empty form, read-only, pre-filled overwrite
- [x] Date formatting: 4 format variations
- [x] Dot-notation: nested objects and array indices
- [x] New fixtures: `createComprehensiveForm()`, `createPreFilledForm()`
- [x] All 156 tests pass, coverage >= 80%
- [x] Build succeeds
- [ ] Filled PDFs open correctly in viewers (manual verification deferred)
